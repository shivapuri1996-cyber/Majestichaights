<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Majestic Heights Pro</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
:root { 
    --primary: #007AFF; --success: #34C759; --warning: #FF9500; --danger: #FF3B30; 
    --bg: #F2F2F7; --card: rgba(255, 255, 255, 0.9); --text: #1C1C1E; --border: rgba(0,0,0,0.1);
}
[data-theme="dark"] { 
    --bg: #000000; --card: rgba(28, 28, 30, 0.9); --text: #FFFFFF; --border: rgba(255,255,255,0.1);
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'SF Pro Display', sans-serif; }
body { background: var(--bg); color: var(--text); padding: 16px; transition: 0.3s; }

header { 
    background: linear-gradient(135deg, #007AFF, #5856D6); 
    padding: 25px 20px; border-radius: 20px; color: white; margin-bottom: 20px; 
    box-shadow: 0 8px 20px rgba(0,122,255,0.2); 
}
header h1 { font-size: 1.6rem; }

.tabs { display: flex; background: rgba(118,118,128,0.12); border-radius: 12px; padding: 4px; margin-bottom: 20px; }
.tab-btn { flex: 1; padding: 10px; border: 0; background: transparent; cursor: pointer; font-weight: 600; border-radius: 10px; color: var(--text); font-size: 0.8rem; }
.tab-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

.tab-content { display: none; }
.tab-content.active { display: block; }

.form-card { background: var(--card); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
.form-group { margin-bottom: 12px; }
label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.8rem; opacity: 0.7; }
input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; outline: none; }

.btn { padding: 14px; border-radius: 12px; border: 0; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; transition: 0.2s; }
.btn-primary { background: var(--primary); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-danger { background: var(--danger); color: white; }

.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
.summary-item { padding: 15px; border-radius: 15px; color: white; text-align: center; }
.sum-blue { background: linear-gradient(135deg, #007AFF, #00C6FF); }
.sum-green { background: linear-gradient(135deg, #34C759, #32E0C4); }
.sum-red { background: linear-gradient(135deg, #FF3B30, #FF2D55); }
.amount { font-size: 1.1rem; font-weight: 700; display: block; }

.table-container { background: var(--card); border-radius: 15px; overflow-x: auto; border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; min-width: 300px; }
th { padding: 12px; background: rgba(0,0,0,0.02); font-size: 0.65rem; color: #8E8E93; text-transform: uppercase; }
td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

.img-preview { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); }

#loader { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 9999; }
.theme-btn, .fab { position: fixed; border: 0; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.theme-btn { top: 15px; right: 15px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); color: white; }
.fab { bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; font-size: 1.2rem; }
.flex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

.action-btn { border: 0; background: transparent; padding: 8px; cursor: pointer; font-size: 1.1rem; border-radius: 50%; transition: 0.2s; }
.btn-wa { color: #32CD32; background: rgba(60, 179, 113, 0.2);} 
.btn-wa:hover { background: rgba(50, 205, 50, 0.2); }
.btn-del { color: var(--danger); }
</style>
</head>
<body>

<div id="loader">Syncing...</div>
<button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
<button class="fab" onclick="openTab('form')"><i class="fas fa-plus"></i></button>

<div class="container" id="screenshotArea">
    <header>
        <h1>Majestic Heights</h1>
        <p style="font-size: 0.8rem; opacity: 0.9;">Shivapuri Billing System</p>
    </header>

    <div class="tabs">
        <button class="tab-btn active" data-tab="form">Entry</button>
        <button class="tab-btn" data-tab="dashboard">Bills</button>
        <button class="tab-btn" data-tab="bulk">Bulk</button>
        <button class="tab-btn" data-tab="salary">Salary</button>
        <button class="tab-btn" data-tab="maintenance">Maint.</button>
    </div>

    <div id="form" class="tab-content active">
        <div class="form-card">
            <div class="form-group"><label>Flat No</label><select id="flat" onchange="autoFillPrev()"><option value="">Select</option><option>101</option><option>102</option><option>201</option><option>202</option><option>301</option><option>302</option></select></div>
            <div class="form-group"><label>Month</label><select id="month"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div>
            <div class="form-group"><label>Prev Reading</label><input id="prev" type="number" readonly></div>
            <div class="form-group"><label>Curr Reading</label><input id="current" type="number" oninput="calculateUnits()"></div>
            <div class="form-group"><label>Consumed</label><input id="consumed" type="number" readonly></div>
            <div class="form-group"><label>Amount (₹)</label><input id="amount" type="number"></div>
            <button class="btn btn-success" onclick="saveAndSendBill()">Save & WhatsApp</button>
            <button class="btn btn-primary" onclick="saveOnly()">Save Fast</button>
        </div>
    </div>

    <div id="dashboard" class="tab-content">
        <div class="form-card" style="display:flex; gap:10px">
            <select id="monthFilter" onchange="filterDashboard()"></select>
            <button class="btn btn-primary" style="margin:0; width:70px" onclick="captureScreenshot('screenshotArea')"><i class="fas fa-camera"></i></button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Flat</th>
                        <th>Prev</th>
                        <th>Curr</th>
                        <th>Cons.</th>
                        <th>Amt</th>
                        <th>WA</th>
                        <th>Del</th>
                    </tr>
                </thead>
                <tbody id="billBody"></tbody>
            </table>
        </div>
    </div>

    <div id="bulk" class="tab-content">
        <div class="form-card">
            <div class="form-group"><label>Floor</label><select id="bulkFloor" onchange="loadFlatsForBulk()"><option value="">Select</option><option value="1">1st Floor</option><option value="2">2nd Floor</option><option value="3">3rd Floor</option><option value="4">Common</option></select></div>
            <div class="form-group"><label>Total Amount</label><input id="bulkTotalAmount" type="number"></div>
            <div id="bulkFlatInputs"></div>
            <button class="btn btn-success" onclick="generateBulkBills()">Generate & Save</button>
        </div>
    </div>

    <div id="salary" class="tab-content">
        <div class="flex-header">
            <h3>Staff Salary</h3>
            <button class="btn btn-primary" style="margin:0; width:50px; padding:8px" onclick="captureScreenshot('salary')"><i class="fas fa-camera"></i></button>
        </div>
        <div class="form-card" style="margin-bottom:10px; padding:15px;">
            <label>Monthly Salary Target (Total)</label>
            <input type="number" id="salaryTarget" placeholder="Enter Total Salary" oninput="displaySalary()" value="5000">
        </div>
        <div class="summary-grid">
            <div class="summary-item sum-green"><small>Paid</small><span class="amount" id="salaryTotalPaid">₹0</span></div>
            <div class="summary-item sum-red"><small>Pending Balance</small><span class="amount" id="salaryTotalPending">₹0</span></div>
        </div>
        <div class="form-card">
            <input id="salaryDate" type="date" class="form-group">
            <input id="salaryAmount" type="number" placeholder="Amount Paid" class="form-group">
            <select id="salaryStatus" class="form-group"><option>Paid</option></select>
            <button class="btn btn-primary" onclick="saveSalary()">Save Salary</button>
        </div>
        <div class="table-container"><table><thead><tr><th>Date</th><th>Amt</th><th>Status</th><th></th></tr></thead><tbody id="salaryBody"></tbody></table></div>
    </div>

    <div id="maintenance" class="tab-content">
        <div class="flex-header">
            <h3>Building Fund</h3>
            <button class="btn btn-primary" style="margin:0; width:50px; padding:8px" onclick="captureScreenshot('maintenance')"><i class="fas fa-camera"></i></button>
        </div>
        <div class="summary-grid">
            <div class="summary-item sum-green"><small>In</small><span class="amount" id="maintTotalReceived">0</span></div>
            <div class="summary-item sum-red"><small>Out</small><span class="amount" id="maintTotalExpenses">0</span></div>
            <div class="summary-item sum-blue"><small>Net</small><span class="amount" id="maintNetBalance">0</span></div>
        </div>
        <div class="form-card">
            <input id="maintDate" type="date" class="form-group">
            <input id="maintDesc" type="text" placeholder="Description" class="form-group">
            <input id="maintAmount" type="number" placeholder="Amount" class="form-group">
            <select id="maintType" class="form-group"><option>Received</option><option selected>Expense</option></select>
            <label>Bill Photo</label><input id="maintPhoto" type="file" accept="image/*">
            <button class="btn btn-primary" onclick="saveMaintenance()">Save Entry</button>
        </div>
        <div class="table-container"><table><thead><tr><th>Date</th><th>Desc</th><th>Amt</th><th>Bill</th><th></th></tr></thead><tbody id="maintBody"></tbody></table></div>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbybBMMSElG7Vc7asLAhO8mOhahrhsNlfxybWkgoe7mGetWLCw1a-TQQH7nkO5jLu7B0HQ/exec"; 
let billData = [], lastClosingUnits = {}, salaryData = [], maintenanceData = [];
const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const currentMonthName = monthNames[new Date().getMonth()];
const floors = {1:['101','102'], 2:['201','202'], 3:['301','302'], 4:['Common Area']};

async function cloudSync() {
    document.getElementById('loader').style.display = 'block';
    try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        billData = data.billData || [];
        lastClosingUnits = data.lastClosingUnits || {};
        salaryData = data.salaryData || [];
        maintenanceData = data.maintenanceData || [];
        updateFilterOptions();
        refreshUIs();
    } catch(e) { console.log("Sync failed"); }
    document.getElementById('loader').style.display = 'none';
}

function updateFilterOptions() {
    const filter = document.getElementById('monthFilter');
    const monthsWithData = [...new Set(billData.map(b => b.month))];
    if(!monthsWithData.includes(currentMonthName)) monthsWithData.push(currentMonthName);
    
    filter.innerHTML = monthsWithData.map(m => `<option value="${m}" ${m === currentMonthName ? 'selected' : ''}>${m}</option>`).join('');
}

function filterDashboard(){
    const selectedMonth = document.getElementById('monthFilter').value;
    const body = document.getElementById('billBody'); 
    body.innerHTML = '';
    
    const filtered = billData.filter(b => b.month === selectedMonth);
    
    filtered.forEach(b => {
        body.innerHTML += `<tr>
            <td>${b.flat}</td>
            <td>${b.prev}</td>
            <td>${b.current}</td>
            <td><b>${b.consumed}</b></td>
            <td>₹${b.amount}</td>
            <td><button class="action-btn btn-wa" onclick="resend('${b.id}')"><i class="fab fa-whatsapp"></i></button></td>
            <td><button class="action-btn btn-del" onclick="deleteItem('Bills','${b.id}')"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    });
}

function fastPost(sheetName, action, rowData, id = null) {
    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ sheetName, action, rowData, id })
    });
    
    if(action === 'add') {
        if(sheetName === 'Salary') salaryData.push({id: rowData[0], date: rowData[1], amount: rowData[2], status: rowData[3]});
        if(sheetName === 'Bills') billData.push({id: rowData[0], month: rowData[1], flat: rowData[2], prev: rowData[3], current: rowData[4], consumed: rowData[5], amount: rowData[6], toDate: rowData[7]});
        if(sheetName === 'Maintenance') maintenanceData.push({id: rowData[0], date: rowData[1], desc: rowData[2], amount: rowData[3], type: rowData[4], photo: rowData[5]});
    }
    if(action === 'delete') {
        if(sheetName === 'Bills') billData = billData.filter(b => b.id != id);
        if(sheetName === 'Salary') salaryData = salaryData.filter(b => b.id != id);
        if(sheetName === 'Maintenance') maintenanceData = maintenanceData.filter(b => b.id != id);
    }
    refreshUIs();
}

function autoFillPrev(){ document.getElementById('prev').value = lastClosingUnits[document.getElementById('flat').value] || 0; }
function calculateUnits(){ 
    const p = parseFloat(document.getElementById('prev').value)||0; 
    const c = parseFloat(document.getElementById('current').value)||0; 
    document.getElementById('consumed').value = Math.max(c-p, 0); 
}

function saveOnly(){
    const d = { 
        id: "B"+Date.now(), 
        flat: document.getElementById('flat').value, 
        month: document.getElementById('month').value, 
        current: document.getElementById('current').value, 
        prev: document.getElementById('prev').value, 
        consumed: document.getElementById('consumed').value, 
        amount: document.getElementById('amount').value,
        date: new Date().toLocaleDateString()
    };
    if(!d.flat || !d.current) return alert("Fill all fields");
    fastPost("Units", "updateUnit", [d.flat, d.current]);
    fastPost("Bills", "add", [d.id, d.month, d.flat, d.prev, d.current, d.consumed, d.amount, d.date]);
    document.getElementById('current').value = ''; document.getElementById('amount').value = '';
}

function saveAndSendBill(){
    const flat = document.getElementById('flat').value;
    const curr = document.getElementById('current').value;
    const prev = document.getElementById('prev').value;
    const cons = document.getElementById('consumed').value;
    const amt = document.getElementById('amount').value;
    const mnt = document.getElementById('month').value;
    
    if(!flat || !curr) return alert("Fill all fields");
    
    const message = formatBillMessage({
        month: mnt,
        flat: flat,
        date: new Date().toLocaleDateString(),
        prev: prev,
        current: curr,
        consumed: cons,
        amount: amt
    });

    saveOnly();
    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
}

function formatBillMessage(b) {
    return `*Majestic Heights - Shivapuri*\n\n` +
           `*Electricity Bill - ${b.month}*\n\n` +
           `Flat No: *${b.flat}*\n` +
           `Reading Date: ${b.date || 'Today'}\n` +
           `Previous Reading: ${b.prev} units\n` +
           `Current Reading: ${b.current} units\n` +
           `Total Consumed: *${b.consumed} units*\n\n` +
           `*Amount: Rs ${b.amount}/-*\n\n` +
           `Please pay at the earliest.\n` +
           `Thank you!\n` +
           `Majestic Heights`;
}

function resend(id){
    const b = billData.find(x => x.id == id);
    const msg = formatBillMessage({
        month: b.month,
        flat: b.flat,
        date: b.toDate,
        prev: b.prev,
        current: b.current,
        consumed: b.consumed,
        amount: b.amount
    });
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
}

function deleteItem(sheet, id){ if(confirm("Delete?")) fastPost(sheet, "delete", null, id); }

function saveSalary(){
    const r = ["S"+Date.now(), document.getElementById('salaryDate').value, document.getElementById('salaryAmount').value, document.getElementById('salaryStatus').value];
    fastPost("Salary", "add", r);
}

function displaySalary(){
    const body = document.getElementById('salaryBody'); body.innerHTML = ''; 
    const target = parseFloat(document.getElementById('salaryTarget').value) || 0;
    let paidTotal = 0;
    salaryData.forEach(s => {
        paidTotal += parseFloat(s.amount) || 0;
        body.innerHTML += `<tr><td>${s.date}</td><td>₹${s.amount}</td><td>${s.status}</td><td><button onclick="deleteItem('Salary','${s.id}')">X</button></td></tr>`;
    });
    let pending = target - paidTotal;
    document.getElementById('salaryTotalPaid').innerText = "₹" + paidTotal; 
    document.getElementById('salaryTotalPending').innerText = "₹" + (pending < 0 ? 0 : pending);
}

async function saveMaintenance(){
    const file = document.getElementById('maintPhoto').files[0];
    let photo = ""; if(file) { const reader = new FileReader(); reader.readAsDataURL(file); photo = await new Promise(res => reader.onload = () => res(reader.result)); }
    const r = ["M"+Date.now(), document.getElementById('maintDate').value, document.getElementById('maintDesc').value, document.getElementById('maintAmount').value, document.getElementById('maintType').value, photo];
    fastPost("Maintenance", "add", r);
}
function displayMaintenance(){
    const body = document.getElementById('maintBody'); body.innerHTML = ''; let r=0, e=0;
    maintenanceData.forEach(m => {
        if(m.type==='Received') r+=parseFloat(m.amount); else e+=parseFloat(m.amount);
        const img = m.photo ? `<img src="${m.photo}" class="img-preview" onclick="window.open('${m.photo}')">` : '-';
        body.innerHTML += `<tr><td>${m.date}</td><td>${m.desc}</td><td>₹${m.amount}</td><td>${img}</td><td><button onclick="deleteItem('Maintenance','${m.id}')">X</button></td></tr>`;
    });
    document.getElementById('maintTotalReceived').innerText = "₹"+r; document.getElementById('maintTotalExpenses').innerText = "₹"+e; document.getElementById('maintNetBalance').innerText = "₹"+(r-e);
}

function refreshUIs(){ filterDashboard(); displaySalary(); displayMaintenance(); }
function toggleTheme(){ document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='dark'?'':'dark'); }
function openTab(t){ document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelector(`[data-tab="${t}"]`).classList.add('active'); }
document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => openTab(btn.dataset.tab));

function captureScreenshot(elementId){ 
    const el = document.getElementById(elementId);
    html2canvas(el, { backgroundColor: null }).then(c => { 
        const a = document.createElement('a'); a.href = c.toDataURL(); a.download = `${elementId}_Report.png`; a.click(); 
    }); 
}

function loadFlatsForBulk(){ const f = document.getElementById('bulkFloor').value; const c = document.getElementById('bulkFlatInputs'); c.innerHTML = ''; if(!f) return; floors[f].forEach(fl => c.innerHTML += `<div class="form-group"><label>Flat ${fl}</label><input type="number" id="bulk_${fl}"></div>`); }
async function generateBulkBills(){
    const floor = document.getElementById('bulkFloor').value; const total = parseFloat(document.getElementById('bulkTotalAmount').value); let cons = 0; let items = [];
    floors[floor].forEach(f => { const curr = parseFloat(document.getElementById(`bulk_${f}`).value)||0; const prev = parseFloat(lastClosingUnits[f]||0); const diff = Math.max(curr-prev, 0); cons += diff; items.push({f, curr, prev, diff}); });
    for(let i of items){ const amt = Math.round((i.diff/cons)*total); fastPost("Units", "updateUnit", [i.f, i.curr]); fastPost("Bills", "add", ["B"+Date.now()+i.f, currentMonthName, i.f, i.prev, i.curr, i.diff, amt, new Date().toLocaleDateString()]); }
    openTab('dashboard');
}

window.onload = cloudSync;
</script>
</body>
</html>
